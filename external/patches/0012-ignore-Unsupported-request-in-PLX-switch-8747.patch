From 46f1ed8bc5596fe2e3ceba30c6d0797bf47ae19d Mon Sep 17 00:00:00 2001
From: Xue Bosheng <bosheng.xue@@intel.com>
Date: Thu, 14 Jan 2021 10:18:41 -0500
Subject: [PATCH 12/18] ignore Unsupported request in PLX switch 8747

---
 drivers/pci/quirks.c | 16 ++++++++++++++++
 1 file changed, 16 insertions(+)

diff --git a/drivers/pci/quirks.c b/drivers/pci/quirks.c
index 419dda6..8e48669 100644
--- a/drivers/pci/quirks.c
+++ b/drivers/pci/quirks.c
@@ -5216,3 +5216,19 @@ out_disable:
 DECLARE_PCI_FIXUP_CLASS_FINAL(PCI_VENDOR_ID_NVIDIA, 0x13b1,
 			      PCI_CLASS_DISPLAY_VGA, 8,
 			      quirk_reset_lenovo_thinkpad_p50_nvgpu);
+
+static void plx_ignore_ur(struct pci_dev *pdev)
+{
+	int cap;
+	u32 mask;
+
+	cap = pci_find_ext_capability(pdev, PCI_EXT_CAP_ID_ERR);
+	if (cap) {
+		pci_read_config_dword(pdev, cap + PCI_ERR_UNCOR_MASK, &mask);
+		mask |= PCI_ERR_UNC_UNSUP;
+		pci_write_config_dword(pdev, cap + PCI_ERR_UNCOR_MASK, mask);
+		dev_info(&pdev->dev, "ignore unspported request in PLX switch 8747\n");
+	}
+}
+
+DECLARE_PCI_FIXUP_FINAL(PCI_VENDOR_ID_PLX, 0x8747, plx_ignore_ur);
-- 
1.8.3.1

